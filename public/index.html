<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grok 流式聊天</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC",
          "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      }
      body {
        margin: 0;
        background: #0b0d12;
        color: #e6e8ee;
      }
      .app {
        max-width: 900px;
        margin: 0 auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box;
        gap: 16px;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .title {
        font-size: 22px;
        font-weight: 600;
      }
      .messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        background: #111521;
        border-radius: 12px;
        overflow-y: auto;
      }
      .message {
        padding: 12px 14px;
        border-radius: 10px;
        white-space: pre-wrap;
        line-height: 1.5;
      }
      .message.user {
        align-self: flex-end;
        background: #2f3b52;
      }
      .message.assistant {
        align-self: flex-start;
        background: #1e2433;
      }
      .composer {
        display: flex;
        gap: 10px;
        background: #111521;
        padding: 12px;
        border-radius: 12px;
      }
      textarea {
        flex: 1;
        resize: none;
        border: none;
        background: transparent;
        color: inherit;
        font-size: 16px;
        outline: none;
        min-height: 52px;
      }
      button {
        background: #4c6fff;
        color: #fff;
        border: none;
        padding: 0 20px;
        border-radius: 10px;
        font-size: 15px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .meta {
        display: flex;
        gap: 12px;
        font-size: 13px;
        color: #9aa3b2;
      }
      select,
      input[type="number"] {
        background: #0f1320;
        border: 1px solid #2a3246;
        color: inherit;
        border-radius: 8px;
        padding: 6px 8px;
      }
      @media (max-width: 640px) {
        .app {
          padding: 16px;
        }
        button {
          padding: 0 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="title">Grok AI 交流</div>
        <div class="meta">
          <label>
            模型
            <select id="model">
              <option value="grok-4-1-fast-reasoning" selected>grok-4-1-fast-reasoning</option>
            </select>
          </label>
          <label>
            温度
            <input id="temperature" type="number" min="0" max="1.5" step="0.1" value="0.7" />
          </label>
        </div>
      </div>
      <div id="messages" class="messages"></div>
      <div class="composer">
        <textarea id="input" placeholder="输入内容，Shift+Enter 换行"></textarea>
        <button id="send">发送</button>
      </div>
    </div>
    <script>
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const modelEl = document.getElementById("model");
      const tempEl = document.getElementById("temperature");

      const history = [];

      const addMessage = (role, content) => {
        const el = document.createElement("div");
        el.className = `message ${role}`;
        el.textContent = content;
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return el;
      };

      const updateMessage = (el, content) => {
        el.textContent = content;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      };

      const parseSse = (chunk, onData) => {
        const lines = chunk.split("\n");
        for (const line of lines) {
          const trimmed = line.trim();
          if (!trimmed.startsWith("data:")) continue;
          const data = trimmed.slice(5).trim();
          if (data === "[DONE]") return;
          try {
            const json = JSON.parse(data);
            onData(json);
          } catch {}
        }
      };

      const sendMessage = async () => {
        const content = inputEl.value.trim();
        if (!content) return;
        inputEl.value = "";
        const userEl = addMessage("user", content);
        history.push({ role: "user", content });
        const assistantEl = addMessage("assistant", "");
        sendBtn.disabled = true;
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: modelEl.value,
              temperature: Number(tempEl.value),
              messages: history,
            }),
          });
          if (!response.ok || !response.body) {
            throw new Error(`请求失败 ${response.status}`);
          }
          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let assistantText = "";
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            parseSse(chunk, (json) => {
              const delta = json?.choices?.[0]?.delta?.content;
              if (delta) {
                assistantText += delta;
                updateMessage(assistantEl, assistantText);
              }
            });
          }
          history.push({ role: "assistant", content: assistantText });
        } catch (error) {
          updateMessage(assistantEl, `出错了：${error.message}`);
        } finally {
          sendBtn.disabled = false;
          inputEl.focus();
          userEl.scrollIntoView({ block: "end" });
        }
      };

      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
